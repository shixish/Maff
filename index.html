<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Snap</title>
    <style>
      body, html{
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
    </style>
    <script src="js/snap.svg-min.js"></script>
    <script>
      var Point = function(){
        
      }
      
      var Maff = function(){
        var _maff = this;
        var paper = Snap("100%", "100%");
        this.paper = paper;
        var renderEvent = new CustomEvent("Render", {"detail":{"hazcheeseburger":true}});
        
        var Number = this.Number = function(number){
          var _number = this;
          //this.group = paper.group();
          var sircles = [];
          var group = paper.group();
          var position = {
            x: 100,
            y: 100
          };
          var radius = 15, width = radius*2;
          var rows = Math.ceil(Math.sqrt(number));
          var offset = rows*radius;
          var quarterPi = Math.PI/4;
          for (var i = 0; i < number; i++) {
            var x = (i%rows)*width - offset;
            var y = Math.floor(i/rows)*width - offset;
            //var x = position.x + Math.sin((2*i+1)*quarterPi)*radius*Math.floor(i/4);
            //var y = position.y + Math.cos((2*i+1)*quarterPi)*radius*Math.floor(i/4);
            var s = new Sircle(x, y, radius);
            sircles.push(s);
            group.add(s.path);
          }
          
          var resetPos = function(){
            var t = new Snap.Matrix();
            t.translate(position["x"], position["y"]);
            group.transform(t);
          }
          resetPos();
          
          this.setPos = function(x, y){
            position["x"] = x;
            position["y"] = y;
            resetPos();
            return _number;
          }
          
          //var rotation = 0;
          //document.addEventListener("Render",function(){
          //  var t = new Snap.Matrix();
          //  t.translate(position["x"], position["y"]);
          //  t.rotate(rotation++);
          //  group.transform(t);
          //},false);
        }
        
        var wobbleAmount = .5, wobbleAmountx2 = wobbleAmount*2;
        var WobblePoint = function(segment, id){
          var svgPoint = function(segment, id) {
            var segment = segment;
            var id = id||"";
            this.setPos = function(x, y){
              segment["x"+id] = x;
              segment["y"+id] = y;
            }
          }
          
          var _point = this;
          var enabled = false;
          id = id||""
          var segments = [new svgPoint(segment, id)];
          var position = {
            x: segment["x"+id],
            y: segment["y"+id],
          };
          var offset = {
            x: 0,
            y: 0,
          };
          var momentum = {
            x: 0,
            y: 0,
          };
          
          //this.enable = function(){
          //  if (!enabled) {
          //    enabled = true;
          //    document.addEventListener("Render",function(e){
          //      if (enabled) {
          //        _point.wobble();
          //      }/*else{
          //        document.removeEventListener('Render', e, false);
          //      }*/
          //    }, false);
          //  }
          //}
          //this.enable();
          //
          //this.disable = function(){
          //  if (enabled) {
          //    enabled = false;
          //  }
          //}
          
          var calculatePosition = function(label){
            var m = momentum[label];
            var o = offset[label];
            //console.log(m, o);
            momentum[label] = m = m/1.5 + Math.random()*wobbleAmountx2-wobbleAmount - o/10;
            offset[label] = o = o + m;
            
            return position[label] + o;
          }
          
          this.wobble = function(){
            var x = calculatePosition("x");
            var y = calculatePosition("y");
            for (var s in segments) {
              segments[s].setPos(x, y);
            }
          }
          
          this.addSegment = function(segment, id){
            segments.push(new svgPoint(segment, id));
            return _point;
          }
          
          this.toString = function(){
            return x+","+y;
          }
        }
        
        var WobbleSegment = function(segment){
          var _segment = this;
          var segment = segment;
          this.enabled = true;
          this.position = new WobblePoint(segment);
          this.cPoint1 = new WobblePoint(segment, 1);
          this.cPoint2 = new WobblePoint(segment, 2);
          
          document.addEventListener("Render",function(){
            if (_segment.enabled) {
              //_segment.position.wobble(); //can't do this because then the ends don't match up.
              _segment.cPoint1.wobble();
              _segment.cPoint2.wobble();
            }
          },false);
        }
        
        //WobbleSegment.combine = function(s1, s2){
        //  console.log(s1, s2)
        //  s1.enabled = false;
        //  s2.enabled = false;
        //}
        
        //it's not really a circle... it's a Sircle!
        var Sircle = function(x, y, r){
          var _sircle = this;
          var diamater = r*2,
              diamater_25 = diamater*.25,
              diamater_50 = diamater*.50,
              diamater_75 = diamater*.75;
          var data = {
            x: x,
            y: y,
            top:{
              x: diamater,
              y: 0,
              x1: diamater_25,
              y1: -diamater_25,
              x2: diamater_75,
              y2: -diamater_25,
            },
            right:{
              x: 0,
              y: diamater,
              x1: diamater_25,
              y1: diamater_25,
              x2: diamater_25,
              y2: diamater_75,
            },
            bottom:{
              x: -diamater,
              y: 0,
              x1: -diamater_25,
              y1: diamater_25,
              x2: -diamater_75,
              y2: diamater_25,
            },
            left:{
              x: 0,
              y: -diamater,
              x1: -diamater_25,
              y1: -diamater_25,
              x2: -diamater_25,
              y2: -diamater_75,
            },
          };
          
          var pathString = Snap.format(
            "M{x},{y}"
            +"c{top.x1},{top.y1} {top.x2},{top.y2} {top.x},{top.y}"
            +"c{right.x1},{right.y1} {right.x2},{right.y2} {right.x},{right.y}"
            +"c{bottom.x1},{bottom.y1} {bottom.x2},{bottom.y2} {bottom.x},{bottom.y}"
            +"c{left.x1},{left.y1} {left.x2},{left.y2} {left.x},{left.y}"
            +"Z"
          , data);
          this.path = paper.path(pathString).attr({
            fill: "#bada55",
            stroke: "#000",
            "stroke-width": 3
          });
          
          var movePoint = this.path.node.pathSegList.getItem(0);
          this.move = function(x, y) {
            movePoint.x = x;
            movePoint.y = y;
          }
          this.segments = {
            //move: this.path.node.pathSegList.getItem(0),
            top: new WobbleSegment(this.path.node.pathSegList.getItem(1)),
            right: new WobbleSegment(this.path.node.pathSegList.getItem(2)),
            bottom: new WobbleSegment(this.path.node.pathSegList.getItem(3)),
            left: new WobbleSegment(this.path.node.pathSegList.getItem(4))
          }
          window.test = this.path.node.pathSegList.getItem(1);
        }
        
        window.n1 = new Number(7);
        window.n2 = new Number(14).setPos(400,100);
        
        (function animloop(){
          requestAnimFrame(animloop);
          document.dispatchEvent(renderEvent);
        })();
      }
      
      window.requestAnimFrame = (function(){
        return  window.requestAnimationFrame       ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame    ||
                function( callback ){
                  window.setTimeout(callback, 1000 / 60);
                };
      })();
      
      window.onload = function () {
        var maff = new Maff();
      }
    </script>
  </head>
  <body></body>
</html>